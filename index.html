<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>限定動画ページ＋コメント機能</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    #login, #viewer { display: none; }
    input, textarea {
      padding: 8px;
      font-size: 1em;
      margin: 5px;
    }
    button {
      padding: 8px 16px;
      font-size: 1em;
    }
    #commentList {
      margin-top: 20px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .comment-box {
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
    }
  </style>
</head>
<body>

<h2>🎥 限定動画ページ 🎥</h2>

<div id="login">
  <p>パスワードを入力してください：</p>
  <input type="password" id="password">
  <button onclick="checkPassword()">ログイン</button>
</div>

<div id="viewer">
  <h3>限定動画をお楽しみください</h3>
  <iframe src="https://drive.google.com/file/d/1QLOY-8MyvT7oadCQEJ2T--QBouHk9DNv/preview"
          width="800" height="450" allow="autoplay"></iframe>
  <p style="margin-top: 20px;">
    <a href="https://drive.google.com/drive/folders/1916qD4SN577CZ3fwKvB_jjDLNxbwj0FY?usp=sharing" target="_blank">
      他の動画フォルダを見る（別ウィンドウで開く）
    </a>
  </p>

  <h3>💬 コメントを投稿する</h3>
  <form id="commentForm">
    <input type="text" id="username" placeholder="名前" required>
    <br>
    <textarea id="comment" placeholder="コメントを入力..." rows="3" cols="40" required></textarea>
    <br>
    <button type="submit">コメント送信</button>
  </form>

  <div id="commentList">
    <h4>📃 コメント一覧</h4>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0J5x7akK0Vex8OPaIHKryc2NswnhekSA",
    authDomain: "movie-comment-aaf52.firebaseapp.com",
    projectId: "movie-comment-aaf52",
    storageBucket: "movie-comment-aaf52.appspot.com",
    messagingSenderId: "368444743168",
    appId: "1:368444743168:web:2641b37c79a7f7683202e5",
    measurementId: "G-3VCG0P27TG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ログイン処理
  const correctPassword = "twitchfan";
  document.getElementById("login").style.display = "block";

  window.checkPassword = function () {
    const input = document.getElementById("password").value;
    if (input === correctPassword) {
      document.getElementById("login").style.display = "none";
      document.getElementById("viewer").style.display = "block";
      loadComments();
    } else {
      alert("パスワードが違います。Discordで確認してください。");
    }
  };

  // コメント読み込み
  async function loadComments() {
    const q = query(collection(db, "comments"), orderBy("timestamp", "desc"));
    const querySnapshot = await getDocs(q);
    const commentList = document.getElementById("commentList");

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "comment-box";
      const time = data.timestamp?.toDate().toLocaleString() || "";
      div.innerHTML = `<strong>${data.username}</strong> (${time})<br>${data.comment}`;
      commentList.appendChild(div);
    });
  }

  // コメント送信
  document.getElementById("commentForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("username").value;
    const comment = document.getElementById("comment").value;

    await addDoc(collection(db, "comments"), {
      username,
      comment,
      timestamp: serverTimestamp()
    });

    alert("コメントを投稿しました！");
    location.reload(); // 再読み込みで表示更新
  });
</script>

</body>
</html>
